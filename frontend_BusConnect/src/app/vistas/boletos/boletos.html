<div class="main-content">
<div class="info-grid">
    <div class="info-card">
        <h2 class="section-title">Reserva en lÃ­nea para asegurar tu asiento en el prÃ³ximo viaje.</h2>
    
  <mat-stepper [linear]="isLinear" #stepper>
  
    <!-- Step Destino de viaje -->
    <mat-step [stepControl]="secondFormGroup">
      <form [formGroup]="secondFormGroup">
      <ng-template matStepLabel>Destino</ng-template>

      <div class="payment-section">
        <mat-form-field class = "control-full-width" >
          <mat-label>Origen</mat-label>
          <input matInput formControlName="fromCtrl" placeholder="Ej. Guatemala"
                 required>
                 <mat-error *ngIf="secondFormGroup.get('fromCtrl')?.hasError('required')">
                  Campo requerido
                </mat-error>
        </mat-form-field>

        <mat-form-field class = "control-full-width">
          <mat-label>Destino</mat-label>
          <input matInput formControlName="toCtrl" placeholder="Ej. Quetzaltenango"
                 required>
                 <mat-error *ngIf="secondFormGroup.get('toCtrl')?.hasError('required')">
                  Campo requerido
                </mat-error>
        </mat-form-field>
      </div>

        <div class ="step-buttons">
          <button matButton matStepperPrevious>Regresar</button>
          <button matButton matStepperNext>Siguiente</button>
        </div>
      </form>
    </mat-step>

         <!-- Step Fecha-->
         <mat-step [stepControl]="thirdFormGroup">
            <form [formGroup]="thirdFormGroup">
            <ng-template matStepLabel>Fecha</ng-template>

            <div class="payment-section">
                <mat-form-field>
                    <mat-label>Fecha</mat-label>
                    <input matInput [matDatepicker]="picker" formControlName="date" required>
                    <mat-hint>MM/DD/YYYY</mat-hint>
                    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                    <mat-error *ngIf="thirdFormGroup.get('date')?.hasError('required')">
                      La fecha es requerida
                    </mat-error>
                  </mat-form-field>
                </div>

              <div class = "step-buttons">
                <button matButton matStepperPrevious>Regresar</button>
                <button matButton matStepperNext>Siguiente</button>
              </div>
            </form>
          </mat-step>

<!-- STEP: SelecciÃ³n de Bus -->
<mat-step [stepControl]="busFormGroup">
  <form [formGroup]="busFormGroup">
    <ng-template matStepLabel>Bus</ng-template>

    <div class="payment-section">
    <mat-form-field class="control-full-width">
      <mat-label>Bus</mat-label>
      <mat-select formControlName="bus" required>
        <mat-option *ngFor="let bus of availableBuses" [value]="bus.id">{{ bus.name }}</mat-option>
      </mat-select>
      <mat-error *ngIf="busFormGroup.get('bus')?.hasError('required')">Seleccione un bus</mat-error>
    </mat-form-field>
    </div>

    <div class = "step-buttons">
      <button matButton matStepperPrevious>Regresar</button>
      <button matButton matStepperNext>Siguiente</button>
    </div>
  </form>
</mat-step>

          <!-- STEP: SelecciÃ³n de asiento -->
          <mat-step>
            <ng-template matStepLabel>Asientos</ng-template>
    
            <div class="bus-container">
              <img src="https://pc.kosokubus.com/include/ib/img/seats_page/img_standard.jpg" alt="Diagrama de asientos del bus" class="bus-image">
    
              <ng-container *ngFor="let seat of seats">
                <div class="seat" [ngClass]="getSeatClass(seat.status)"
                  [style.top.px]="seat.top" [style.left.px]="seat.left"
                  (click)="selectSeat(seat.number)">
                  {{ seat.number }}
                </div>
              </ng-container>
            </div>
    
            <div class="seat-legend">
              <span class="legend available">ðŸŸ© Disponible</span>
              <span class="legend occupied">ðŸŸ¥ Ocupada</span>
              <span class="legend reserved">ðŸŸ¨ Reservada</span>
            </div>
    
            <div class = "step-buttons">
              <button mat-button matStepperPrevious>Regresar</button>
              <button mat-button [disabled]="selectedSeats.length === 0" (click)="onSeatsNext()">

                Siguiente
              </button>
              
            </div>
          </mat-step>
    
          <!-- STEP Datos-->
          <mat-step>
            <ng-template matStepLabel>Datos</ng-template>

            <form [formGroup]="passengerFormGroup">
            <div class="section-form">
              <h3>Datos de los Pasajeros</h3>

              <div formArrayName="passengers" class="passenger-grid"  >
              <div *ngFor="let form of passengerFormArray.controls; let i = index" [formGroup]="form" class="passenger-form">
                <h4>Pasajero Asiento #{{ selectedSeats[i] }}</h4>

              <mat-form-field appearance="fill" class="control-compact">
                <mat-label>Nombre</mat-label>
                <input matInput formControlName="name" placeholder="Apellido, Nombre">
                <mat-error *ngIf="form.get('name')?.hasError('required')">Este campo es obligatorio</mat-error>
              </mat-form-field>
        
              <mat-form-field appearance="fill" class="control-compact">
                <mat-label>DPI o Pasaporte</mat-label>
                <input matInput formControlName="id">
                <mat-error *ngIf="form.get('id')?.hasError('required')">Este campo es obligatorio</mat-error>
              </mat-form-field>
            
              <mat-form-field  appearance="fill" class="control-compact">
                <mat-label>Celular</mat-label>
                <input matInput formControlName="phone">
                <mat-error *ngIf="form.get('phone')?.hasError('required')">Este campo es obligatorio</mat-error>
                <mat-error *ngIf="form.get('phone')?.hasError('pattern')">Debe tener 8 dÃ­gitos</mat-error>
              </mat-form-field>
              <hr>
              </div>
            </div>
            </div>
    
            <div class="timer" *ngIf="!paymentConfirmed">
              Tiempo restante: <strong>{{ countdown }}</strong>
            </div>

            </form>

            <div class = "step-buttons">
              <button mat-button matStepperPrevious>Regresar</button>
              <button matButton matStepperNext>Siguiente</button>
            </div>
          </mat-step>
    
             <!-- STEP Pago -->
             <mat-step>
              <ng-template matStepLabel>Pago</ng-template>
              <form #paymentForm="ngForm">
              <div class="payment-section">
                <h3>Boletos</h3>
                
                <div *ngFor="let form of passengerFormArray.controls; let i = index" [formGroup]="form">
                <p><strong>Asiento:</strong> {{ selectedSeats[i] }}</p>
                <p><strong>Nombre:</strong> {{ form.get('name')?.value }}</p>
                <p><strong>DPI/Pasaporte:</strong> {{ form.get('id')?.value }}</p>
                <p><strong>Celular:</strong> {{ form.get('phone')?.value }}</p>
                <p><strong>Origen:</strong> {{ secondFormGroup.get('fromCtrl')?.value }}</p>
                <p><strong>Destino:</strong> {{ secondFormGroup.get('toCtrl')?.value }}</p>
                <p><strong>Fecha:</strong> {{ thirdFormGroup.get('date')?.value | date }}</p>
                <p><strong>Bus:</strong> {{ getSelectedBusName() }}</p>
                <p><strong>Asiento:</strong> {{ selectedSeats[i] }}</p>
                <p><strong>Total a pagar:</strong> Q125</p>
                <hr>
              </div>

              <mat-form-field class="control-full-width">
                <mat-label>Correo electrÃ³nico</mat-label>
                <input matInput [(ngModel)]="email" name="email" required email>
              </mat-form-field>
              
              <mat-form-field class="control-compact">
                <mat-label>NÃºmero de tarjeta</mat-label>
                <input matInput [(ngModel)]="cardInfo.cardNumber" name="cardNumber" required pattern="^[0-9]{16}$">
              </mat-form-field>

              <div class="row-two">
                <mat-form-field class="control-compact half">
                  <mat-label>MM/YY</mat-label>
                  <input matInput [(ngModel)]="cardInfo.expiry" name="expiry" required pattern="^(0[1-9]|1[0-2])\/\d{2}$">
                </mat-form-field>

                <mat-form-field class="control-compact half">
                  <mat-label>CVV</mat-label>
                  <input matInput [(ngModel)]="cardInfo.cvv" name="cvv" required pattern="^[0-9]{3}$">
                </mat-form-field>
              </div>
              
              <div class="timer"*ngIf="!paymentConfirmed">
                Tiempo restante: <strong>{{ countdown }}</strong>
              </div>
              <button mat-raised-button color="warn"
                      (click)="paySeat()"
                      [disabled]="paymentConfirmed || !paymentForm.form.valid">
                Pagar Boleto
              </button>
              <div *ngIf="paymentConfirmed" class="confirmation-message">
                âœ… Pago confirmado
              </div>
            </div>
          </form>
          <div class="step-buttons">
            <button mat-button matStepperPrevious>Regresar</button>
            <button mat-button (click)="stepper.next()" [disabled]="!paymentConfirmed">Finalizar</button>
          </div>
            </mat-step>
      
          <!-- STEP 6: Final -->
          <mat-step>
            <ng-template matStepLabel >Listo</ng-template>
            <p class="section-title">Tu boleto ha sido reservado.</p>

            <div class = "step-buttons">
              <button mat-button matStepperPrevious>AtrÃ¡s</button>
              <button mat-raised-button color="primary" (click)="verReserva()" class="button-reserva">
                Ver Reserva
              </button>
            </div>
          </mat-step>
    
        </mat-stepper>
      </div>
    </div>
  </div>